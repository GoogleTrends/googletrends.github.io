<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<title>Hurricane Sandy</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />


    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.css" />
    <!--[if lte IE 8]>
      <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.ie.css" />
    <![endif]-->
    <!--Switch between the different themes changing the stylesheet below - light-theme.css |dark-theme.css -->
    <script type="text/javascript" src="http://www.maps.google.com/maps/api/js?sensor=false&v=3.12"></script>
    <script>
      var script = '<script src="https://googlemaps.github.io/js-rich-marker//src/richmarker';
      if (document.location.search.indexOf('compiled') !== -1) {
        script += '-compiled';
      }
      script += '.js"><' + '/script>';
      document.write(script);
    </script>

    <script src="http://libs.cartocdn.com/cartodb.js/v3/3.11/cartodb.js"></script>

<style>
  body { margin:0; padding:0; }
  #map { position:absolute; top:0; bottom:0; width:100%; }
</style>
</head>
<body>
<div id='map'></div>

<script>
function main() {
  // Generate a GeoJSON line. You could also load GeoJSON via AJAX
  // or generate it some other way.
  var geojson = {"type":"LineString","coordinates":[[-77.4,14.3],[-77.4333333333333,14.2666666666667],[-77.4666666666667,14.2333333333333],[-77.5,14.2],[-77.5333333333333,14.1666666666667],[-77.5666666666667,14.1333333333333],[-77.6,14.1],[-77.6333333333333,14.0666666666667],[-77.6666666666667,14.0333333333333],[-77.7,14],[-77.7333333333333,13.9666666666667],[-77.7666666666667,13.9333333333333],[-77.8,13.9],[-77.8333333333333,13.8666666666667],[-77.8666666666667,13.8333333333333],[-77.9,13.8],[-77.9333333333333,13.7666666666667],[-77.9666666666667,13.7333333333333],[-78,13.7],[-78.0333333333333,13.6666666666667],[-78.0666666666667,13.6333333333333],[-78.1,13.6],[-78.1333333333333,13.5666666666667],[-78.1666666666667,13.5333333333333],[-78.2,13.5],[-78.2333333333333,13.4666666666667],[-78.2666666666667,13.4333333333333],[-78.3,13.4],[-78.3333333333333,13.3666666666667],[-78.3666666666667,13.3333333333333],[-78.4,13.3],[-78.4333333333333,13.2666666666667],[-78.4666666666667,13.2333333333333],[-78.5,13.2],[-78.5333333333333,13.1666666666667],[-78.5666666666667,13.1333333333333],[-78.6,13.1],[-78.6083333333333,13.0666666666667],[-78.6166666666667,13.0333333333333],[-78.625,13],[-78.6333333333333,12.9666666666667],[-78.6416666666667,12.9333333333333],[-78.65,12.9],[-78.6583333333333,12.8666666666667],[-78.6666666666667,12.8333333333333],[-78.675,12.8],[-78.6833333333333,12.7666666666667],[-78.6916666666667,12.7333333333333],[-78.7,12.7],[-78.675,12.6916666666667],[-78.65,12.6833333333333],[-78.625,12.675],[-78.6,12.6666666666667],[-78.575,12.6583333333333],[-78.55,12.65],[-78.525,12.6416666666667],[-78.5,12.6333333333333],[-78.475,12.625],[-78.45,12.6166666666667],[-78.425,12.6083333333333],[-78.4,12.6],[-78.375,12.625],[-78.35,12.65],[-78.325,12.675],[-78.3,12.7],[-78.275,12.725],[-78.25,12.75],[-78.225,12.775],[-78.2,12.8],[-78.175,12.825],[-78.15,12.85],[-78.125,12.875],[-78.1,12.9],[-78.0833333333333,12.9416666666667],[-78.0666666666667,12.9833333333333],[-78.05,13.025],[-78.0333333333333,13.0666666666667],[-78.0166666666667,13.1083333333333],[-78,13.15],[-77.9833333333333,13.1916666666667],[-77.9666666666667,13.2333333333333],[-77.95,13.275],[-77.9333333333333,13.3166666666667],[-77.9166666666667,13.3583333333333],[-77.9,13.4],[-77.875,13.45],[-77.85,13.5],[-77.825,13.55],[-77.8,13.6],[-77.775,13.65],[-77.75,13.7],[-77.725,13.75],[-77.7,13.8],[-77.675,13.85],[-77.65,13.9],[-77.625,13.95],[-77.6,14],[-77.575,14.0583333333333],[-77.55,14.1166666666667],[-77.525,14.175],[-77.5,14.2333333333333],[-77.475,14.2916666666667],[-77.45,14.35],[-77.425,14.4083333333333],[-77.4,14.4666666666667],[-77.375,14.525],[-77.35,14.5833333333333],[-77.325,14.6416666666667],[-77.3,14.7],[-77.2833333333333,14.775],[-77.2666666666667,14.85],[-77.25,14.925],[-77.2333333333333,15],[-77.2166666666667,15.075],[-77.2,15.15],[-77.1833333333333,15.225],[-77.1666666666667,15.3],[-77.15,15.375],[-77.1333333333333,15.45],[-77.1166666666667,15.525],[-77.1,15.6],[-77.0833333333333,15.6833333333333],[-77.0666666666667,15.7666666666667],[-77.05,15.85],[-77.0333333333333,15.9333333333333],[-77.0166666666667,16.0166666666667],[-77,16.1],[-76.9833333333333,16.1833333333333],[-76.9666666666667,16.2666666666667],[-76.95,16.35],[-76.9333333333333,16.4333333333333],[-76.9166666666667,16.5166666666667],[-76.9,16.6],[-76.8833333333333,16.6916666666667],[-76.8666666666667,16.7833333333333],[-76.85,16.875],[-76.8333333333333,16.9666666666667],[-76.8166666666667,17.0583333333333],[-76.8,17.15],[-76.7833333333333,17.2416666666667],[-76.7666666666667,17.3333333333333],[-76.75,17.425],[-76.7333333333333,17.5166666666667],[-76.7166666666667,17.6083333333333],[-76.7,17.7],[-76.65,17.8],[-76.6,17.9],[-76.58,18],[-76.56,18.1],[-76.54,18.2],[-76.52,18.3],[-76.5,18.4],[-76.48,18.5],[-76.46,18.6],[-76.44,18.7],[-76.42,18.8],[-76.4,18.9],[-76.3636363636364,19],[-76.3272727272727,19.1],[-76.2909090909091,19.2],[-76.2545454545455,19.3],[-76.2181818181818,19.4],[-76.1818181818182,19.5],[-76.1454545454545,19.6],[-76.1090909090909,19.7],[-76.0727272727273,19.8],[-76.0363636363636,19.9],[-76,20],[-76,20.1],[-75.95,20.2333333333333],[-75.9,20.3666666666667],[-75.85,20.5],[-75.8,20.6333333333333],[-75.75,20.7666666666667],[-75.7,20.9],[-75.6666666666667,21.0333333333333],[-75.6333333333333,21.1666666666667],[-75.6,21.3],[-75.5666666666667,21.4333333333333],[-75.5333333333333,21.5666666666667],[-75.5,21.7],[-75.4833333333333,21.8333333333333],[-75.4666666666667,21.9666666666667],[-75.45,22.1],[-75.4333333333333,22.2333333333333],[-75.4166666666667,22.3666666666667],[-75.4,22.5],[-75.3833333333333,22.6333333333333],[-75.3666666666667,22.7666666666667],[-75.35,22.9],[-75.3333333333333,23.0333333333333],[-75.3166666666667,23.1666666666667],[-75.3,23.3],[-75.35,23.425],[-75.4,23.55],[-75.45,23.675],[-75.5,23.8],[-75.55,23.925],[-75.6,24.05],[-75.65,24.175],[-75.7,24.3],[-75.75,24.425],[-75.8,24.55],[-75.85,24.675],[-75.9,24.8],[-75.9416666666667,24.875],[-75.9833333333333,24.95],[-76.025,25.025],[-76.0666666666667,25.1],[-76.1083333333333,25.175],[-76.15,25.25],[-76.1916666666667,25.325],[-76.2333333333333,25.4],[-76.275,25.475],[-76.3166666666667,25.55],[-76.3583333333333,25.625],[-76.4,25.7],[-76.4416666666667,25.7583333333333],[-76.4833333333333,25.8166666666667],[-76.525,25.875],[-76.5666666666667,25.9333333333333],[-76.6083333333333,25.9916666666667],[-76.65,26.05],[-76.6916666666667,26.1083333333333],[-76.7333333333333,26.1666666666667],[-76.775,26.225],[-76.8166666666667,26.2833333333333],[-76.8583333333333,26.3416666666667],[-76.9,26.4],[-76.925,26.45],[-76.95,26.5],[-76.975,26.55],[-77,26.6],[-77.025,26.65],[-77.05,26.7],[-77.075,26.75],[-77.1,26.8],[-77.125,26.85],[-77.15,26.9],[-77.175,26.95],[-77.2,27],[-77.1916666666667,27.0416666666667],[-77.1833333333333,27.0833333333333],[-77.175,27.125],[-77.1666666666667,27.1666666666667],[-77.1583333333333,27.2083333333333],[-77.15,27.25],[-77.1416666666667,27.2916666666667],[-77.1333333333333,27.3333333333333],[-77.125,27.375],[-77.1166666666667,27.4166666666667],[-77.1083333333333,27.4583333333333],[-77.1,27.5],[-77.0833333333333,27.55],[-77.0666666666667,27.6],[-77.05,27.65],[-77.0333333333333,27.7],[-77.0166666666667,27.75],[-77,27.8],[-76.9833333333333,27.85],[-76.9666666666667,27.9],[-76.95,27.95],[-76.9333333333333,28],[-76.9166666666667,28.05],[-76.9,28.1],[-76.8666666666667,28.1583333333333],[-76.8333333333333,28.2166666666667],[-76.8,28.275],[-76.7666666666667,28.3333333333333],[-76.7333333333333,28.3916666666667],[-76.7,28.45],[-76.6666666666667,28.5083333333333],[-76.6333333333333,28.5666666666667],[-76.6,28.625],[-76.5666666666667,28.6833333333333],[-76.5333333333333,28.7416666666667],[-76.5,28.8],[-76.425,28.875],[-76.35,28.95],[-76.275,29.025],[-76.2,29.1],[-76.125,29.175],[-76.05,29.25],[-75.975,29.325],[-75.9,29.4],[-75.825,29.475],[-75.75,29.55],[-75.675,29.625],[-75.6,29.7],[-75.525,29.7666666666667],[-75.45,29.8333333333333],[-75.375,29.9],[-75.3,29.9666666666667],[-75.225,30.0333333333333],[-75.15,30.1],[-75.075,30.1666666666667],[-75,30.2333333333333],[-74.925,30.3],[-74.85,30.3666666666667],[-74.775,30.4333333333333],[-74.7,30.5],[-74.6333333333333,30.5666666666667],[-74.5666666666667,30.6333333333333],[-74.5,30.7],[-74.4333333333333,30.7666666666667],[-74.3666666666667,30.8333333333333],[-74.3,30.9],[-74.2333333333333,30.9666666666667],[-74.1666666666667,31.0333333333333],[-74.1,31.1],[-74.0333333333333,31.1666666666667],[-73.9666666666667,31.2333333333333],[-73.9,31.3],[-73.825,31.3583333333333],[-73.75,31.4166666666667],[-73.675,31.475],[-73.6,31.5333333333333],[-73.525,31.5916666666667],[-73.45,31.65],[-73.375,31.7083333333333],[-73.3,31.7666666666667],[-73.225,31.825],[-73.15,31.8833333333333],[-73.075,31.9416666666667],[-73,32],[-72.9166666666667,32.0666666666667],[-72.8333333333333,32.1333333333333],[-72.75,32.2],[-72.6666666666667,32.2666666666667],[-72.5833333333333,32.3333333333333],[-72.5,32.4],[-72.4166666666667,32.4666666666667],[-72.3333333333333,32.5333333333333],[-72.25,32.6],[-72.1666666666667,32.6666666666667],[-72.0833333333333,32.7333333333333],[-72,32.8],[-71.9166666666667,32.8916666666667],[-71.8333333333333,32.9833333333333],[-71.75,33.075],[-71.6666666666667,33.1666666666667],[-71.5833333333333,33.2583333333333],[-71.5,33.35],[-71.4166666666667,33.4416666666667],[-71.3333333333333,33.5333333333333],[-71.25,33.625],[-71.1666666666667,33.7166666666667],[-71.0833333333333,33.8083333333333],[-71,33.9],[-70.9583333333333,34.0166666666667],[-70.9166666666667,34.1333333333333],[-70.875,34.25],[-70.8333333333333,34.3666666666667],[-70.7916666666667,34.4833333333333],[-70.75,34.6],[-70.7083333333333,34.7166666666667],[-70.6666666666667,34.8333333333333],[-70.625,34.95],[-70.5833333333333,35.0666666666667],[-70.5416666666667,35.1833333333333],[-70.5,35.3],[-70.5416666666667,35.4333333333333],[-70.5833333333333,35.5666666666667],[-70.625,35.7],[-70.6666666666667,35.8333333333333],[-70.7083333333333,35.9666666666667],[-70.75,36.1],[-70.7916666666667,36.2333333333333],[-70.8333333333333,36.3666666666667],[-70.875,36.5],[-70.9166666666667,36.6333333333333],[-70.9583333333333,36.7666666666667],[-71,36.9],[-71.1833333333333,37.0166666666667],[-71.3666666666667,37.1333333333333],[-71.55,37.25],[-71.7333333333333,37.3666666666667],[-71.9166666666667,37.4833333333333],[-72.1,37.6],[-72.2833333333333,37.7166666666667],[-72.4666666666667,37.8333333333333],[-72.65,37.95],[-72.8333333333333,38.0666666666667],[-73.0166666666667,38.1833333333333],[-73.2,38.3],[-73.3333333333333,38.3833333333333],[-73.4666666666667,38.4666666666667],[-73.6,38.55],[-73.7333333333333,38.6333333333333],[-73.8666666666667,38.7166666666667],[-74,38.8],[-74.08,38.92],[-74.16,39.04],[-74.24,39.16],[-74.32,39.28],[-74.4,39.4],[-74.5,39.5],[-74.6416666666667,39.5333333333333],[-74.7833333333333,39.5666666666667],[-74.925,39.6],[-75.0666666666667,39.6333333333333],[-75.2083333333333,39.6666666666667],[-75.35,39.7],[-75.4916666666667,39.7333333333333],[-75.6333333333333,39.7666666666667],[-75.775,39.8],[-75.9166666666667,39.8333333333333],[-76.0583333333333,39.8666666666667],[-76.2,39.9],[-76.3333333333333,39.9166666666667],[-76.4666666666667,39.9333333333333],[-76.6,39.95],[-76.7333333333333,39.9666666666667],[-76.8666666666667,39.9833333333333],[-77,40],[-77.1333333333333,40.0166666666667],[-77.2666666666667,40.0333333333333],[-77.4,40.05],[-77.5333333333333,40.0666666666667],[-77.6666666666667,40.0833333333333],[-77.8,40.1],[-77.8916666666667,40.125],[-77.9833333333333,40.15],[-78.075,40.175],[-78.1666666666667,40.2],[-78.2583333333333,40.225],[-78.35,40.25],[-78.4416666666667,40.275],[-78.5333333333333,40.3],[-78.625,40.325],[-78.7166666666667,40.35],[-78.8083333333333,40.375],[-78.9,40.4],[-78.975,40.425],[-79.05,40.45],[-79.125,40.475],[-79.2,40.5],[-79.275,40.525],[-79.35,40.55],[-79.425,40.575],[-79.5,40.6],[-79.575,40.625],[-79.65,40.65],[-79.725,40.675],[-79.8,40.7],[-79.8416666666667,40.7333333333333],[-79.8833333333333,40.7666666666667],[-79.925,40.8],[-79.9666666666667,40.8333333333333],[-80.0083333333333,40.8666666666667],[-80.05,40.9],[-80.0916666666667,40.9333333333333],[-80.1333333333333,40.9666666666667],[-80.175,41],[-80.2166666666667,41.0333333333333],[-80.2583333333333,41.0666666666667],[-80.3,41.1],[-80.3333333333333,41.1333333333333],[-80.3666666666667,41.1666666666667],[-80.4,41.2],[-80.4333333333333,41.2333333333333],[-80.4666666666667,41.2666666666667],[-80.5,41.3],[-80.5333333333333,41.3333333333333],[-80.5666666666667,41.3666666666667],[-80.6,41.4],[-80.6333333333333,41.4333333333333],[-80.6666666666667,41.4666666666667]]}

  var vizj = "https://googledataorg.cartodb.com/u/googledata/api/v2/viz/94df3240-2684-11e5-acb9-42010a14e62a/viz.json";
  // var marker;
  var start = new Date("2012/10/21 18:00:00 GMT-0400").getTime();
  var end = new Date("2012/10/31 11:30:00 GMT-0400").getTime();

  var map;

  RichMarker.prototype.setOpacity =function(value){
    $(".hurr").css( "opacity", value);
  }
  RichMarker.prototype.setIcon =function(url){
    $(".hurr").attr( "src", url);
  }
  RichMarker.prototype.rotateIcon =function(degree){
    $(".hurr").css( {
      'transform': 'rotate('+degree+'deg)',
      '-ms-transform': 'rotate('+degree+'deg)', /* IE 9 */
      '-moz-transform': 'rotate('+degree+'deg)', /* Firefox */
      '-webkit-transform': 'rotate('+degree+'deg)', /* Safari and Chrome */
      '-o-transform': 'rotate('+degree+'deg)' /* Opera */
    });
  }

  var marker = new RichMarker({
          map: map,
          draggable: false,
          position: new google.maps.LatLng( geojson.coordinates[0][1], geojson.coordinates[0][0] ) ,
          shadow: false,
          content: '<img src="hurricane-40.png" class="hurr"/>'
      });

  cartodb.createVis('map', vizj)
    .done(function(viz,layr){
      map = viz.getNativeMap();
      var torqueLayer = layr[1];
      marker.setMap(map);
      // check(torqueLayer);
      torqueLayer.on('change:time', function(data) {
        var dt = new Date(data.time);
        dt.setYear(2012);
        dt = dt.getTime()
        // the linestring has a point at every 30 minutes
        // 1800000 = 30 minutes
        var c = Math.floor((dt - start)/1800000.0);
        if (c > 0){
          // after sandy
          if (c < geojson.coordinates.length){
            // before end of storm
            // move the marker
            marker.setPosition( new google.maps.LatLng( geojson.coordinates[c][1], geojson.coordinates[c][0] ) );
            marker.rotateIcon(-720.0*c/geojson.coordinates.length)
            if (c >= 125 ){
              // hurricane status
              marker.setIcon('hurricane-40.png');
              if ( 20 > geojson.coordinates.length - c) {
                // fade out
                marker.setOpacity((geojson.coordinates.length-c+1) / 20.0)
              } else {
                marker.setOpacity(1);
              }
            } else if (c < 125) {
              // ts status
              marker.setIcon('tropical-storm-40.png');
              if (c <= 20){
                // fade in
                marker.setOpacity(c/20);
              } else {
                marker.setOpacity(1);
              }
            }
          } else {
            marker.setOpacity(0);
          }
        } else {
          // before sandy
          marker.setOpacity(0);
        }
      });
    })

}

window.onload = main; 
</script>
</body>
</html>