<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<title>Hurricane Katrina</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />


    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.15/themes/css/cartodb.css" />
    <!--[if lte IE 8]>
      <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.ie.css" />
    <![endif]-->
    <!--Switch between the different themes changing the stylesheet below - light-theme.css |dark-theme.css -->
    <script type="text/javascript" src="http://www.maps.google.com/maps/api/js?sensor=false&v=3.12"></script>


    <script src="http://libs.cartocdn.com/cartodb.js/v3/3.15/cartodb.js"></script>


<style>
  body { margin:0; padding:0; }
  #map { position:absolute; top:0; bottom:0; width:100%; }
</style>
</head>
<body>
<div id='map'></div>

<script>
function main() {
  // Generate a GeoJSON line. You could also load GeoJSON via AJAX
  // or generate it some other way.
  var geojson ={type : "LineString", coordinates:[[-75.1,23.1],[-75.7,23.4],[-76.2,23.8],[-76.5,24.5],[-76.9,25.4],[-77.7,26],[-78.4,26.1],[-79,26.2],[-79.6,26.2],[-80.3,25.9],[-81.3,25.4],[-82,25.1],[-82.6,24.9],[-83.3,24.6],[-84,24.4],[-84.7,24.4],[-85.3,24.5],[-85.9,24.8],[-86.7,25.2],[-87.7,25.7],[-88.6,26.3],[-89.2,27.2],[-89.6,28.2],[-89.6,29.5],[-89.6,31.1],[-89.1,32.6],[-88.6,34.1],[-88,35.6],[-87,37],[-85.3,38.6],[-82.9,40.1]]}

  var vizj = "https://team.cartodb.com/u/stuartlynn/api/v2/viz/05f2886c-4753-11e5-982c-0e8dde98a187/viz.json";
  // var marker;
  var start = new Date("2005/08/23 18:00:00 UTC")
  var end   = new Date("2005/08/31 06:00:00 UTC")

  console.log("start", start)
  console.log("end", end)
  // var start = new Date("2005/08/01 00:00:00 UTC").getTime();
  // var end   = new Date("2006/01/01 00:00:00 UTC").getTime();


  var map;

  var icon =  L.divIcon({className: 'hurr', html  :"<img src='hurricane-40.png'></img>", iconSize:[40,40]});

  setOpacity =function(value){
    $(".hurr").css( "opacity", value);
  }

  rotateIcon =function(degree){

    $(".hurr img").css( {
      'transform': 'rotate('+degree+'deg)',
      '-ms-transform': 'rotate('+degree+'deg)', /* IE 9 */
      '-moz-transform': 'rotate('+degree+'deg)', /* Firefox */
      '-webkit-transform': 'rotate('+degree+'deg)', /* Safari and Chrome */
      '-o-transform': 'rotate('+degree+'deg)' /* Opera */
    });
  }


  cartodb.createVis('map', vizj)
    .done(function(viz,layr){
      map = viz.getNativeMap();
      var torqueLayer = layr[2];
      var marker = L.marker([geojson.coordinates[0][1], geojson.coordinates[0][0]], {icon: icon}).addTo(map);
      // check(torqueLayer);
      torqueLayer.on('change:time', function(data) {
        console.log("changing")
        var dt = new Date(data.time);
        dt.setYear(2005);
        dt = dt.getTime()
        // the linestring has a point at every 6 hours
        // 21600000 = 6hours
        console.log(dt-start.getTime())
        var cf= (dt - start)/21600000.0
        var c = Math.floor(cf);
        console.log(c)
        if (c > 0){
          // after sandy
          if (c < geojson.coordinates.length){
            // before end of storm
            // move the marker

            setOpacity(1);
            var nextLat =  geojson.coordinates[c+1][1]
            var nextLon =  geojson.coordinates[c+1][0]

            var interpLat  = (nextLat - geojson.coordinates[c][1])*(cf-c) + geojson.coordinates[c][1]
            var interpLon  = (nextLon - geojson.coordinates[c][0])*(cf-c) + geojson.coordinates[c][0]

            marker.setLatLng( new L.LatLng( interpLat, interpLon ) );
            rotateIcon(-720.0*cf/geojson.coordinates.length)
          } else {
            setOpacity(0);
          }
        } else {
          // before sandy
          setOpacity(0);
        }
      });
    })

}

window.onload = main;
</script>
</body>
</html>
